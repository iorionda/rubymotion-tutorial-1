
<!doctype html>
  <head>
    <title> Models |  RubyMotion Tutorial</title>
    <meta name="description" content="Best practices for iOS and RubyMotion models with NSObject, NSCoding, and KVO Key-Value Observing" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="robots" content="all" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta name="author" content="Clay Allsopp" />

    <meta property="og:title" content="RubyMotion Tutorial: Write iOS apps in Ruby" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="http://rubymotion-tutorial.com/" />
    <meta property="og:image" content="http://i.imgur.com/mndCd.png" />
    <meta property="og:site_name" content="RubyMotion Tutorial" />
    <meta property="og:description" content="Learn to write iOS apps in Ruby.">
    <meta property="fb:admins" content="1398782310" />
    <meta property="fb:app_id" content="340990539314215" />

    <meta name=viewport content="width=device-width, initial-scale=1.0,maximum-scale = 1.0">

    <link rel=stylesheet href='http://clayallsopp.github.com/rubymotion-tutorial/css/bootstrap.min.css'>
    <link rel=stylesheet href='http://clayallsopp.github.com/rubymotion-tutorial/css/bootstrap-responsive.min.css'>
    <link rel=stylesheet href='http://clayallsopp.github.com/rubymotion-tutorial/css/blog/pygments.css'>
    <link rel=stylesheet href='http://clayallsopp.github.com/rubymotion-tutorial/css/patch.css'>
    <link rel=stylesheet href='http://clayallsopp.github.com/rubymotion-tutorial/css/chapter.css'>
    

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-33404343-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>

  <body>
    <a id="fork-me" href="https://github.com/clayallsopp/rubymotion-tutorial" target="_blank">Fork me on GitHub</a>
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span2" id="derp">
            <nav>
            <ul class="nav nav-list">
              <li class="nav-header" id="chapter-nav-btn">
                Chapters <i class="icon-chevron-up" id="chapter-nav-chevron"></i>
              </li>
            </ul>
            <ul class="nav nav-list" id="chapter-nav">
              
                <li >
                  <a href="/0-in-motion">In Motion</a>
                </li>
              
                <li >
                  <a href="/1-hello-motion">Hello Motion</a>
                </li>
              
                <li >
                  <a href="/2-views">Views</a>
                </li>
              
                <li >
                  <a href="/3-controllers">Controllers</a>
                </li>
              
                <li >
                  <a href="/4-containers">Containers</a>
                </li>
              
                <li >
                  <a href="/5-tables">Tables</a>
                </li>
              
                <li >
                  <a href="/6-animations">Animations</a>
                </li>
              
                <li  class="active" >
                  <a href="/7-models">Models</a>
                </li>
              
                <li >
                  <a href="/8-testing">Testing</a>
                </li>
              
                <li >
                  <a href="/9-http">HTTP</a>
                </li>
              
                <li >
                  <a href="/10-api-driven-example">API Driven Example</a>
                </li>
              
            </ul>
            <ul class="nav nav-list">
              <li class="divider"></li>
              <li><a href="/">Home</a></li>
              <li><a href="http://github.com/clayallsopp/rubymotion-tutorial">Source</a></li>
              <li class="divider"></li>
            </ul>
          </nav>
        </div>
        <div class="span10" id="content">
          <div id="main">
            <h1 id="toc_19">Models</h1>

<p>これまでビューとコントローラを扱いましたが、MVC の <strong>M</strong> はどこへいってしまったのでしょう？これからモデルに突入するので、これ以上待つ必要はありません。私たちは <strong>VC</strong> パートですでにたくさんのコードを書いてきましたが、一般的にはモデルは本当は 3 つのうち一番巨大になります。</p>

<p>RubyMotion では、モデルのために 2 つ大きなコンポーネントがあります。CoreData とそれ以外のすべてです。CoreData は iOS 向けの ORM の一種で、Rails の ActiveRecord と同様のものです。CoreData は信じられないほど強力なフレームワークで、それ自体で章が成り立つほどです。ここでは、RubyMotion で重要な 「CoreData 以外のすべて」を扱います。それでは、さっそくはじめましょう。</p>

<h2 id="toc_20">Model-T</h2>

<p>モデルは一般的な Ruby のオブジェクトです。インスタンス変数をセット・ゲットするメソッドを宣言する場合に、普通の Ruby の <code>attr_[accessor/reader/writer]</code> を使用することができます。たとえば次のように基本的な <code>User</code> オブジェクトを作ってみましょう。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:id</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span>
  <span class="kp">attr_accessor</span> <span class="ss">:email</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これでオブジェクトを次のように操作することができます。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Clay&quot;</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;clay@mail.com&quot;</span>
</code></pre>
</div>

<p>クールですがリモート API などを扱う場合に、取得するいくつかのデータからおそらく <code>User</code> をパースすることになるでしょう。これを行う方法はいつくかありますが、個人的に次の方法がお気に入りです。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="k">class</span> <span class="nc">User</span>
  <span class="no">PROPERTIES</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="o">]</span>
  <span class="no">PROPERTIES</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">prop</span><span class="o">|</span>
    <span class="kp">attr_accessor</span> <span class="n">prop</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">attributes</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="no">PROPERTIES</span><span class="o">.</span><span class="n">member?</span> <span class="n">key</span><span class="o">.</span><span class="n">to_sym</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これで、次のような巧妙なトリックを行うことができます。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="n">server_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Clay&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="s2">&quot;my@email.com&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">1000</span> <span class="p">}</span>
<span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">server_hash</span><span class="p">)</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
<span class="o">=&gt;</span> <span class="no">Clay</span>
</code></pre>
</div>

<p>このスタイルは、単に定数 <code>PROPERTIES</code> を拡張することでより多くのプロパティを簡単に追加できます。モデルをシリアライズしたり、モデルの属性を何度も処理する必要がある場合にも便利です。あぁ、失礼、これは話の伏線ですね。</p>

<h2 id="toc_21">NSCoding</h2>

<p>それで今は、私たちはモデルにスケーラブルな基盤があり、サーバからいくつかデータを取得しています。データを取得するたびにリモート API を呼び出す代わりに、まずはじめにローカルのコピー (別名: キャッシュ) があるかをチェックしたいと思います。オブジェクトをファイルなどに保存するコードを作成できますが、より良いアイディアがあります。</p>

<p>永続的な key-value ストアとして <code>NSUserDefaults</code> オブジェクトがあります。通常、オブジェクトとして <code>NSUserDefaults.standardUserDefaults</code> のインスタンスを次のように使用することができます。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="vi">@defaults</span> <span class="o">=</span> <span class="no">NSUserDefaults</span><span class="o">.</span><span class="n">standardUserDefaults</span>
<span class="vi">@defaults</span><span class="o">[</span><span class="s2">&quot;one&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># 別の場所で、あるいは、アプリを起動し直して値を取得します</span>
<span class="vi">@defaults</span><span class="o">[</span><span class="s2">&quot;one&quot;</span><span class="o">]</span>
<span class="o">=&gt;</span> <span class="mi">1</span>
</code></pre>
</div>

<p>とても良さそうでしょう？<code>NSUserDefaults</code> の値はアプリがインストールされているあいだ保存されます。値を急いで処理したい場合には、<code>NSUserDefaults.resetStandardUserDefaults</code> を実行することで全てのエントリを消去できます。</p>

<p>ここで注意があります。<code>NSUserDefaults</code> には古いオブジェクトを格納することはできません。プリミティブな値(string, integer, hash など)の格納や生の data/byte 列 は使用することができます。<code>User</code> オブジェクトはプリミティブではないため、data メソッドを使う必要があります。どのように動作するのでしょうか？</p>

<p><code>NSKeyedArchiver</code> を使用しアーカイブ処理を行うことでモデルを配置できます。この <code>NSKeyedArchiver</code> クラスはオブジェクトを受けつけ <code>NSUserDefaults</code> で保存できる <code>NSData</code> のインスタンスを作ります。アーカイブできるオブジェクトは <code>NSCoding</code> に準拠します。つまり、標準的な API を使用し自身をシリアライズ・デシリアライズする方法を定義する 2 つのメソッドを実装することを意味します。もしモデルがこれらのメソッドを実装していない場合、アーカイブすることができません。</p>

<p><code>NSCoding</code> に準拠するための 2 つのメソッドは <code>initWithCoder:</code> (オブジェクトを読み込むために使われます) と <code>encodeWithCoder:</code> (オブジェクトを保存するために使われます) です。これら両方のメソッドには <code>NSCoder</code> のインスタンスが渡され、与えられたキーでプリミティブなオブジェクトをエンコードします。<code>NSKeyedArchiver</code> と <code>NSKeyedUnarchiver</code> はアーカイブされたオブジェクトを保存形式に変換したり、逆に保存形式からアーカイブされたオブジェクトに変換するためにさきほどのメソッドを使用します。</p>

<p>2 つのメソッドはよく似た並びにすべきでしょう。<code>encodeWithCoder</code> はいくつかのキーに対してオブジェクトの値のすべてを <em>エンコード</em> し、それから <code>initWithCoder</code> は <em>エンコード時と同じキー</em> でオブジェクトの値を <em>セット</em> します。</p>

<p>さぁ、例を見てみましょう。二つのメソッドは基本的に正反対のことを行うことに注意してください。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="k">class</span> <span class="nc">Post</span>
  <span class="kp">attr_accessor</span> <span class="ss">:message</span>
  <span class="kp">attr_accessor</span> <span class="ss">:id</span>

  <span class="c1"># NSUserDefaults からオブジェクトが読み込まれる時に呼び出されます。</span>
  <span class="c1"># イニシャライザなので、`self` を返さなければなりません。</span>
  <span class="k">def</span> <span class="nf">initWithCoder</span><span class="p">(</span><span class="n">decoder</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">init</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">decodeObjectForKey</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">decodeObjectForKey</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="nb">self</span>
  <span class="k">end</span>

  <span class="c1"># NSUserDefaults へオブジェクトを保存するときに呼び出されます。</span>
  <span class="k">def</span> <span class="nf">encodeWithCoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span>
    <span class="n">encoder</span><span class="o">.</span><span class="n">encodeObject</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="s2">&quot;message&quot;</span><span class="p">)</span>
    <span class="n">encoder</span><span class="o">.</span><span class="n">encodeObject</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>それではいったい何なのか再び見ていきましょう。上記のコードは <code>NSUserDefaults</code> で保存できるように、オブジェクトをデータに変換してくれます。実際にみてみましょう。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="n">defaults</span> <span class="o">=</span> <span class="no">NSUserDefaults</span><span class="o">.</span><span class="n">standardUserDefaults</span>

<span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">new</span>
<span class="n">post</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;hello!&quot;</span>
<span class="n">post</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">post_as_data</span> <span class="o">=</span> <span class="no">NSKeyedArchiver</span><span class="o">.</span><span class="n">archivedDataWithRootObject</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
<span class="n">defaults</span><span class="o">[</span><span class="s2">&quot;saved_post&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">post_as_data</span>

<span class="c1"># あとで、次のようにこの post データをロードします</span>
<span class="n">post_as_data</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">[</span><span class="s2">&quot;saved_post&quot;</span><span class="o">]</span>
<span class="n">post</span> <span class="o">=</span> <span class="no">NSKeyedUnarchiver</span><span class="o">.</span><span class="n">unarchiveObjectWithData</span><span class="p">(</span><span class="n">post_as_data</span><span class="p">)</span>
</code></pre>
</div>

<p><code>encodeObject</code> と <code>decodeObjectForKey</code> のこれらは長くてとても扱いにくいので、私たちの API モデルの構造を活用して、簡単に扱えるようにしましょう。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="k">class</span> <span class="nc">User</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>

  <span class="k">def</span> <span class="nf">initWithCoder</span><span class="p">(</span><span class="n">decoder</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">init</span>
    <span class="no">PROPERTIES</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">prop</span><span class="o">|</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">decodeObjectForKey</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">prop</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span>
    <span class="p">}</span>
    <span class="nb">self</span>
  <span class="k">end</span>

  <span class="c1"># NSUserDefaults へオブジェクトを保存するときに呼び出されます。</span>
  <span class="k">def</span> <span class="nf">encodeWithCoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span>
    <span class="no">PROPERTIES</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">prop</span><span class="o">|</span>
      <span class="n">encoder</span><span class="o">.</span><span class="n">encodeObject</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">prop</span><span class="p">),</span> <span class="n">forKey</span><span class="p">:</span> <span class="n">prop</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="k">end</span>
</code></pre>
</div>

<p>素敵ですよね？Objective-C の最大の苦痛の一つはモデルに新しい属性を追加することが簡単ではないことです。Ruby コードの魔術は私たちのコードを変更することを楽にしてくれます。</p>

<p>今、私たちは <em>本当に</em> 堅牢で柔軟なモデルを持っています。それでは、変更したものを画面上に配置してみましょう。</p>

<h2 id="toc_22">Key-Value Observing Example</h2>

<p>キー値監視(Key Value Observing、KVO) は本当にすごくクールで、大幅に時間を節約できるでしょう。</p>

<p>RubyMotion では、ほかのオブジェクトの任意のプロパティを監視することができます。それでは、ユーザの名前を監視しているとしましょう。ユーザの &quot;#name&quot; プロパティの値が変更されるとき、コールバックによって自動的に新しい値を取得します。独自の構造や通知を書く必要はありません。</p>

<p>これの実用的な例は、<code>UILabel</code> のようなオブジェクトのプロパティが常に <code>@user.name</code> を示すように関連付けられている view があげられます。name を変更するとき、ラベルは自動的に更新されモデルと同期します。今からそのようなものを実装していきます。</p>

<p>新しい RubyMotion プロジェクトを <code>motion create KeyValueFun</code> のように作成します。あと、<code>User</code> モデルで遊ぶために <code>./app/user.rb</code> というファイルも作成します。</p>

<p>もう一つだけ必要なことがあります。BubbleWrap を使うことです。</p>

<p><a href="http://bubblewrap.io/">BubbleWrap</a> は iOS SDK を Ruby らしく記述できるような wrapper を集めたものです。Apple の API の多くは、コールバックするオブジェクト上であらかじめ決められたメソッドを呼び出す仕組みを使っています。これは Objective-C では好ましいものですが、無名関数が多用される Ruby では望まれません。そこで、BubbleWrap の wrapper の多くは、そのようなコールバックメソッドが単にラムダやブロックとして動作します。キー値監視を本当にシンプルにしてくれる wrapper を使用します。</p>

<p>サードパーティーのライブラリを RubyMotion にどのようにインストールするのでしょう？レポジトリをクローンしてそれをプロジェクトへ追加するか、<a href="http://rubygems.org/pages/download">RubyGems</a> を使うことができます。後者は、サードパーティーのコードのインストールとメンテナンスがとても簡単になるので、新しい RubyMotion ライブラリを gem としてインストールすることができないかチェックすることをおすすめします(もしそうでなければ、fork して直してあげよう！)。</p>

<p>Terminal で <code>gem install bubble-wrap</code> を実行します。ほかの gem のように、BubbleWrap がみなさんのマシンにインストールされます。しかし、RubyMotion 以外のプロジェクトで <code>require &quot;bubble-wrap&quot;</code> とした場合にはエラーとなります。</p>

<p>次のように、<code>Rakefile</code> で <code>require &quot;bubble-wrap&quot;</code> を追加します。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="s2">&quot;/Library/RubyMotion/lib&quot;</span><span class="p">)</span>
<span class="nb">require</span> <span class="s1">&#39;motion/project&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;bubble-wrap&#39;</span>

<span class="o">.</span><span class="n">.</span><span class="o">.</span>
</code></pre>
</div>

<p>さぁ、コードを書いてみましょう。<code>user.rb</code> で、上記の概要に沿った堅牢で API を構築しやすい <code>User</code> クラスか、より簡易的なバージョンを使うことができます。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:id</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span>
  <span class="kp">attr_accessor</span> <span class="ss">:email</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code>AppDelegate</code> では、<code>User</code> の <code>id</code>、 <code>name</code> と <code>email</code> の各フィールドのラベルを作ります。そのあと、オブジェクトのこれら属性の監視を開始し、それに従って各ラベルが更新されます。簡単そうですか？さぁ、それを見ていきましょう。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="k">class</span> <span class="nc">AppDelegate</span>
  <span class="kp">include</span> <span class="no">BW</span><span class="o">::</span><span class="no">KVO</span>

  <span class="kp">attr_accessor</span> <span class="ss">:user</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</code></pre>
</div>

<p>BubbleWrap のナイスな KVO wrapper を使用するために、メソッドを <code>include</code> する必要があります。プロパティを監視する任意のオブジェクトに対してこの操作を行う必要があります。デバッグを楽にするために、<code>#user</code> という属性も追加します。view は以下のようになります。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax">  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span><span class="ss">:launchOptions</span><span class="p">)</span>
    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">applicationFrame</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>

    <span class="vi">@name_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="o">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">30</span><span class="o">]]</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@name_label</span><span class="p">)</span>

    <span class="vi">@email_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="o">[[</span><span class="mi">0</span><span class="p">,</span> <span class="vi">@name_label</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span> <span class="o">+</span> <span class="mi">10</span><span class="o">]</span><span class="p">,</span> <span class="vi">@name_label</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@email_label</span><span class="p">)</span>

    <span class="vi">@id_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="o">[[</span><span class="mi">0</span><span class="p">,</span> <span class="vi">@email_label</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="vi">@email_label</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span> <span class="o">+</span> <span class="mi">10</span><span class="o">]</span><span class="p">,</span> <span class="vi">@name_label</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@id_label</span><span class="p">)</span>

    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</code></pre>
</div>

<p><code>@window</code> にすべてのラベルを追加し、縦に並べています。みなさんはもっときれいな体裁にできますが、ここでは簡単にしておきます。</p>

<p>最後にメインディッシュの <code>observe</code> です。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax">    <span class="o">.</span><span class="n">.</span><span class="o">.</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>

    <span class="o">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">prop</span><span class="o">|</span>
      <span class="n">observe</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="o">|</span>
        <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_label&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">new_value</span>
      <span class="k">end</span>
    <span class="p">}</span>

    <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>KVO の <code>observe</code> メソッドは、<code>observe(#&lt;object to be observed&gt;, &quot;the property&quot;) do ....</code> という形式です。<code>#each</code> メソッドの重複を取り除くためにここで Ruby の素晴らしいトリックを使います。もしプロパティがひとつだけでしたら次のようにすることができます。</p>
<div class="highlight"><pre class='codehilite'><code class="ruby syntax"><span class="n">observe</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="o">|</span>
  <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@name_label&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">new_value</span>
<span class="k">end</span>
</code></pre>
</div>

<p>最高でしょう？ あと、次のことは覚えておいてください。<code>self.user</code> で起きていることを監視するようにしていしているので、<code>self.user</code> に再度オブジェクトを割り当てると監視動作は停止します。<code>self.user = some_other_user</code> とすると停止します。</p>

<p>どのようにテストしたら良いでしょう？<code>rake</code> を実行してデバッグコンソールへ向かいましょう。私たちが正しく掘り下げていれば、<code>User</code> オブジェクトを取得することができ、それで遊ぶことができるはずです。</p>
<div class="highlight"><pre class='codehilite'><code class="text syntax">$ rake
  ...
(main)&gt; delegate = UIApplication.sharedApplication.delegate
=&gt; #&lt;AppDelegate .... &gt;
(main)&gt; user = delegate.user
=&gt; #&lt;NSKVONotifying_User&gt;
(main)&gt; user.email = &quot;test@mail.com&quot;
=&gt; &quot;test@mail.com&quot;
(main)&gt; user.name = &quot;clay&quot;
=&gt; &quot;clay&quot;
(main)&gt; user.id = &quot;9000&quot;
=&gt; &quot;9000&quot;
</code></pre>
</div>

<p>次のような結果となるはずです。</p>

<p><img src="images/0.png" alt="KVO data"></p>

<h2 id="toc_23">Wrapping Up</h2>

<p>ちょっとだけ iOS の魅力的な部分で遊びましたが、確固たるモデルの構造と KVO はユーザエクスペリエンスと同様に重要です。次のことを、ここで学びました。</p>

<ul>
<li>モデルは普通の Ruby オブジェクトです。<code>attr_[accessor/reader/writer]</code> メソッドを使ってプロパティを追加できます。</li>
<li>属性の定義に <code>PROPERTIES</code> という定数を使いました。<code>initialize</code> メソッドでハッシュから読み込むのが本当に簡単になります。</li>
<li><code>NSUserDefaults</code> はプリミティブな永続的ストアです。モデルを保存するために <code>NSKeyedArchiver</code> と <code>NSKeyedUnarchiver</code> を使います。<code>initWithCoder:</code> と  <code>encodeWithCoder:</code> をみなさんのクラスに実装する必要があります。</li>
<li>キー値監視(Key Value Observing、KVO) はみなさんのオブジェクトに、別のオブジェクトのプロパティの変更の通知を受け取ることができるようにします。</li>
<li>簡単にキー値監視を行うために <code>include BW::KVO</code> と <code>observe</code> を使いました。</li>
</ul>

<p><a href="/8-testing">RubyMotion でどのようにテストを行うかを見るためにフォースを使おう！</a></p>

          </div>
          <hr />
          <h2>Like it?<small id="spread"> Spread the word</small></h2>
          <div id="social">
            <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://rubymotion-tutorial.com" data-text="RubyMotion Tutorial: Make iOS Apps With Ruby" data-size="large" data-related="clayallsopp" data-count="none">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

            <iframe id="facebook-like" src="//www.facebook.com/plugins/like.php?href=http%3A%2F%2Frubymotion-tutorial.com&amp;send=false&amp;layout=standard&amp;width=480&amp;show_faces=false&amp;action=like&amp;colorscheme=light&amp;font&amp;height=35&amp;appId=340990539314215" scrolling="no" frameborder="0" allowTransparency="true"></iframe>
          </div>
          <hr />
        </div>
      </div>
    </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
  <script src='http://clayallsopp.github.com/rubymotion-tutorial/js/bootstrap.min.js' type="text/javascript"></script>
  <script src='http://clayallsopp.github.com/rubymotion-tutorial/js/chapters.js' type="text/javascript"></script>
  </body>
</html>